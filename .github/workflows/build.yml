name: Build Ultroid Deployer APK

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install unzip (apt)
        run: sudo apt-get update && sudo apt-get install -y unzip zip rsync

      - name: Create workspace dir
        run: mkdir -p extracted

      - name: Find ZIP in repo root
        id: findzip
        run: |
          ZIP_NAME="Ultroid-Deployer-Final.zip"
          if [ -f "$ZIP_NAME" ]; then
            echo "zip=$ZIP_NAME" >> $GITHUB_OUTPUT
          else
            candidate=$(ls -1 Ultroid-Deployer*.zip 2>/dev/null | head -n1 || true)
            if [ -n "$candidate" ]; then
              echo "zip=$candidate" >> $GITHUB_OUTPUT
            else
              echo "No Ultroid-Deployer zip found in repo root. Please upload Ultroid-Deployer-Final.zip" >&2
              exit 1
            fi
          fi

      - name: Extract project ZIP
        run: |
          echo "Extracting ${{ steps.findzip.outputs.zip }} -> extracted/"
          unzip -o "${{ steps.findzip.outputs.zip }}" -d extracted
          echo "Contents:"
          ls -la extracted || true

      - name: Make extracted scripts executable (if any)
        run: |
          if [ -d extracted/scripts ]; then
            chmod +x extracted/scripts/*.sh || true
            ls -la extracted/scripts || true
          fi

      # --- Setup explicit Flutter SDK version (avoid channel-detection issues) ---
      - name: Setup Flutter SDK (explicit version)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.3'    # <- explicit version used in your logs; change if needed

      - name: Verify flutter
        run: flutter --version

      # --- Create a temporary Flutter skeleton project to ensure correct Gradle structure ---
      - name: Create temporary flutter project (skeleton)
        run: |
          rm -rf temp_flutter_app || true
          flutter create --project-name ultroid_deployer temp_flutter_app
          echo "Temp flutter skeleton created"

      - name: Copy extracted Flutter files into temp project
        run: |
          # If ZIP had an 'app' folder use that, else copy top-level pubspec/lib/assets/android if present
          if [ -d extracted/app ]; then
            echo "Copying extracted/app -> temp_flutter_app"
            rsync -a --delete extracted/app/ temp_flutter_app/
          else
            echo "Copying detected files from extracted/ -> temp_flutter_app/"
            rsync -a --delete extracted/pubspec.yaml temp_flutter_app/ || true
            rsync -a --delete extracted/lib/ temp_flutter_app/lib/ || true
            rsync -a --delete extracted/assets/ temp_flutter_app/assets/ || true
            rsync -a --delete extracted/android/ temp_flutter_app/android/ || true
            rsync -a --delete extracted/ios/ temp_flutter_app/ios/ || true
          fi

          echo "Listing temp_flutter_app:"
          ls -la temp_flutter_app | sed -n '1,200p'

      - name: Get dependencies (flutter pub get)
        working-directory: ./temp_flutter_app
        run: |
          flutter pub get --verbose

      - name: Build APK (release)
        working-directory: ./temp_flutter_app
        run: |
          set -e
          echo "Building release APK..."
          flutter build apk --release --no-tree-shake-icons

      - name: Find APK artifact
        id: findapk
        run: |
          APK=$(find temp_flutter_app/build -type f -name "*-release.apk" -print -quit || true)
          if [ -z "$APK" ]; then
            APK=$(find . -type f -name "*.apk" -print -quit || true)
          fi
          if [ -z "$APK" ]; then
            echo "apk_path=" >> $GITHUB_OUTPUT
            echo "No apk found"
          else
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
            echo "Found apk: $APK"
          fi

      - name: Upload APK artifact
        if: ${{ steps.findapk.outputs.apk_path != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: ${{ steps.findapk.outputs.apk_path }}
          retention-days: 3

      - name: Fail explanation (if APK missing)
        if: ${{ steps.findapk.outputs.apk_path == '' }}
        run: |
          echo "APK not found. Check earlier logs for errors (pub get / build)."
          exit 1
