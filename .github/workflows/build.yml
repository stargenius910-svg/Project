name: Ultroid Deployer Build (Final Kotlin+Java Support)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install unzip and dependencies
        run: |
          sudo apt update
          sudo apt install -y unzip python3 python3-pip openjdk-17-jdk git

      - name: Extract uploaded ZIP
        run: |
          ZIP_FILE=$(ls *.zip | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ No zip found in repo root!"
            exit 1
          fi
          echo "Found ZIP: $ZIP_FILE"
          unzip -o "$ZIP_FILE" -d project
          ls project/android/app/src/main || echo "No android main dir?"

      - name: Auto-Fix for Flutter Android V2 Embedding
        run: |
          cd project/android/app/src/main || exit 1
          TARGET_DIR=""
          if [ -d "java" ]; then
            TARGET_DIR="java"
          elif [ -d "kotlin" ]; then
            TARGET_DIR="kotlin"
          else
            echo "❌ No java or kotlin directory found!"
            exit 1
          fi
          find $TARGET_DIR -name "MainActivity.*" -print0 | while IFS= read -r -d '' file; do
            echo "⚙️ Fixing $file"
            sed -i 's/import io.flutter.app.FlutterActivity;/import io.flutter.embedding.android.FlutterActivity;/g' "$file"
            sed -i 's/extends FlutterActivity/extends FlutterActivity/g' "$file"
          done
          echo "✅ Converted to V2 embedding"

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Get Flutter Dependencies
        run: |
          cd project
          flutter pub get

      - name: Build APK (Release)
        run: |
          cd project
          flutter build apk --release

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ultroid-deployer-apk
          path: project/build/app/outputs/flutter-apk/app-release.apk
